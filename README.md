# Virtual-Machine-For-Embedded-Systems

## Getting started
### Prerequisites: 
1. avr-gcc and avrdude installed and accessible from user path
1. Visual Studio 2019
1. Arduino IDE

### Getting dev environment setup
1. Clone this repo using : git clone https://github.com/MinaSelim/Virtual-Machine-For-Embedded-Systems.git
1. Open the "SOEN422 VM Project.sln" Visual Studio 2019 solution file

### Testing on host
1. In Visual Studio, select the "Release" solution configuration
1. Click Build -> Build Solution
1. Open a file explorer and navigate to the "test_executables" folder
1. Run the "run_tests.bat" file in order to run the T01-T12.exe unit tests, and auto-validate their output with AUnit (the test output will be located in the Txx.txt file generated by the script)
1. Run the "run_st_tests.bat" file in order to run the ST01-ST04.exe + ST01old-ST02old.exe files (their output will be located in the STxx.txt file generated by the script)

### Testing on target
1. Ensure Arduino is connected to your computer and you know its COM port
1. In Visual Studio, select the "atmega328" solution configuration
1. Right click the Cm project in the Solution Explorer -> Properties
1. Select Configuration Properties -> NMake
1. Click on the dropdown associated with the "Build Command Line" parameter, click on <Edit...> (this configuration enables Visual Studio to compile to bin, convert to hex, and upload in one command)
1. Change the COM number in the avrdude upload line to your own, press Ok and close the properties page
1. Click on Build -> Build solution (in order to compile, and flash the avr)
1. Right click the "host-loader" project and click "Set as Startup Project"
1. Right click on "host-loader" again, click Properties, and change the "Application arguments" to the path for test file you'd like to upload
1. You can select any executable from the test executable folder (T01-T12, ST01-ST04, ST01old-ST02old) plz give bonus points 
1. Click on the run button labeled "host-loader"
1. Type "d" to let the AVR know it will be receiving a download
1. Type "e" to upload the executable
1. Type "r" to run the executable on the AVR. The executable's response will be printed to the same command window

### Testing Task 0-2
- Implied by testing on host as shown above

### Testing Task 3
- Implied by testing on target as shown above

### Testing Task 4


### Testing Task 5
- Implied by testing on target as shown above

### Testing Task 6 on target
1. After following the setup steps shown in "Testing on target"
1. Click on the dropdown associated with the "Build Command Line" parameter, click on <Edit...> 
1. Add the following preprocessor directives to the avr-gcc compile command "-D TEST -D TEST_TASK6", the command should look like this 
```
avr-gcc -Wall -fdata-sections -mmcu=atmega328p -Os -D KEEP_ALIVE -D SERIAL_LOADER -D TEST -D TEST_TASK6 -o output.bin admin.c bsl_output_ATmega328p.c bsl_input_ATmega328p.c bsl_interrupt_ATmega328p.c bsl_io_reg_ATmega328p.c bsl_output_host.c hal.c hal_output.c ioreg.c hal_out.c vm.c vmstack.c _console.c _xtoa.c serial_loader.c hal_input.c bsl_TestIOReg0.c hal_TestInterman0.c hal_interrupt.c
```
1. Click Build -> Build solution 
1. Launch Arduino IDE and open the Serial Monitor
1. Don't forget to remove the "-D TEST -D TEST_TASK6" defines before moving on, the reverted command should look like this

### Testing Task 7 on target
1. After following the setup steps shown in "Testing on target"
1. Click on the dropdown associated with the "Build Command Line" parameter, click on <Edit...> 
1. Add the following preprocessor directives to the avr-gcc compile command "-D TEST -D TEST_TASK7", the command should look like this 
```
avr-gcc -Wall -fdata-sections -mmcu=atmega328p -Os -D KEEP_ALIVE -D SERIAL_LOADER -D TEST -D TEST_TASK7 -o output.bin admin.c bsl_output_ATmega328p.c bsl_input_ATmega328p.c bsl_interrupt_ATmega328p.c bsl_io_reg_ATmega328p.c bsl_output_host.c hal.c hal_output.c ioreg.c hal_out.c vm.c vmstack.c _console.c _xtoa.c serial_loader.c hal_input.c bsl_TestIOReg0.c hal_TestInterman0.c hal_interrupt.c
```
1. Click Build -> Build solution 
1. Watch the LED blink on the Arduino
1. Don't forget to remove the "-D TEST -D TEST_TASK7" defines before moving on, the reverted command should look like this


## cm_src
This folder contains the source files for the Cm language, and is what we will be contributing to.

## aunit_src
This folder contains the source file for the AUnit test framework

## text_executables
This folder contains the precompiled test executables, alongside a run_tests.bat file used to run them.